# Utilities for safely managing the filesystem.

# prepare_mount_point(directory, owner)
#   Safely prepares a directory for mounting.
#   - Unmounts the path if currently mounted.
#   - Creates directory if missing.
#   - Sets immutable attribute (+i) on the underlying folder to prevent
#     accidental writes when the drive is NOT mounted.
prepare_mount_point() {
    local dir="$1"
    local owner="$2"

    if mountpoint -q "$dir"; then
        echo "⚠️  Drive currently mounted at $dir. Unmounting to configure mount point..."
        sudo umount "$dir"
        
        # SAFETY CHECK: If unmount failed (busy), STOP immediately.
        if mountpoint -q "$dir"; then
            echo "❌ CRITICAL: Failed to unmount $dir. Target busy. Aborting to protect data."
            exit 1
        fi
    fi

    if [ ! -d "$dir" ]; then
        echo "Creating mount point: $dir"
        sudo mkdir -p "$dir"
    fi

    # Unlock, set owner, then Lock
    # We add '|| true' so it doesn't fail on a fresh directory where the attr isn't set yet
    sudo chattr -i "$dir" 2>/dev/null || true
    
    sudo chown "$owner:$owner" "$dir"
    sudo chmod 755 "$dir"

    sudo chattr +i "$dir"
    echo "Mount point $dir prepared and locked."
}

clean_legacy_fstab() {
    local id="$1" # either UUID or //chopin/share
    local mount_path="$2"
    local fstab="/etc/fstab"

    # 1. Remove by ID (UUID or SMB Path)
    if grep -q "$id" "$fstab"; then
        echo "Removing legacy fstab entry for ID='$id'..."
        sudo sed -i "\|$id|d" "$fstab"
    fi

    # 2. Remove by Mount Path (Target)
    if grep -qE "^$mount_path[[:space:]]" "$fstab"; then
        echo "Removing legacy fstab entry for path=$mount_path..."
        sudo sed -i "\|^$mount_path[[:space:]]|d" "$fstab"
    fi

    sudo systemctl daemon-reload
}


update_fstab() {
    local id="$1"
    local mount_point="$2"
    local entry="$3"

    # Delegate cleanup to the helper function
    clean_legacy_fstab "$id" "$mount_point"

    echo "Adding/Updating entry for '$id'..."
    echo "$entry" | sudo tee -a "/etc/fstab" > /dev/null
    
    sudo systemctl daemon-reload
}
