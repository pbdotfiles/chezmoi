# --- Launch/Attach tmux automatically, but only if not already inside it
# We check if $TMUX is empty AND if the shell is interactive
if [ -z "$TMUX" ] && [ -n "$PS1" ]; then
    tmux attach || tmux new -s main
fi

export PATH="$HOME/.local/bin:$HOME/bin:$PATH"
export EDITOR="nvim"
export VISUAL="nvim"

eval "$(starship init bash)"
eval "$(fzf --bash)"

{{- $features := dig .chezmoi.hostname (dict) .hosts_features -}}

{{- if (dig "setup_gui" false $features) }}
# PyCharm is only installed on GUI machines
# export PATH="$HOME/.local/share/applications/pycharm-community-2024.2/bin:$PATH"
{{- end }}

{{- if (dig "setup_nvidia" false $features) }}
# Nvidia specific aliases
alias nvidia-limit="sudo nvidia-smi -pm 1 && sudo nvidia-smi -pl 100"
{{- end }}

{{- if eq .chezmoi.hostname "fractal" }}
# This alias seems specific to the 'fractal' machine (specific path on /mnt/ext4_data)
alias tm="cd /mnt/ext4_data/projects/trackmania_rl/ && conda activate tm311"
{{- end }}


HISTSIZE=100000
HISTFILESIZE=100000
shopt -s histappend
PROMPT_COMMAND="history -a; history -c; history -r; $PROMPT_COMMAND"

#---  NVM Configuration: lazy-loaded
export NVM_DIR="$HOME/.nvm"
_load_nvm() {
    # Remove these stubs so they don't loop
    unset -f nvm node npm npx
    # Load NVM for real
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
}

# Create "stubs" that load NVM only when called
nvm()  { _load_nvm; nvm "$@"; }
node() { _load_nvm; node "$@"; }
npm()  { _load_nvm; npm "$@"; }
npx()  { _load_nvm; npx "$@"; }

{{- if eq .chezmoi.hostname "ALFR-CY5VCK3-L" }}
export NODE_EXTRA_CA_CERTS="/usr/local/share/ca-certificates/ZscalerRootCA.crt"
{{- end }}

#--- Add a "tempwork" command that creates a temporary directory that will be automatically deleted after exit.
tempwork() {
  local tdir
  tdir=$(mktemp -d)
  # Open a new sub-shell inside the temp directory
  (
    cd "$tdir" || return
    echo "Entering temporary workspace: $tdir"
    echo "This directory will be deleted when you type 'exit'."
    $SHELL
    rm -rf "$tdir"
    echo "Workspace $tdir deleted."
  )
}
