# --- Launch/Attach tmux automatically, but only if not already inside it
if [ -z "$TMUX" ] && [ -n "$PS1" ]; then
    if tmux ls >/dev/null 2>&1; then
        # Sessions exist, so attach to the most recent one
        exec tmux attach
    else
        # No sessions exist, create a new one named 'main'
        exec tmux new
    fi
fi

export PATH="$HOME/.local/bin:$HOME/bin:$PATH"
export EDITOR="nvim"
export VISUAL="nvim"

eval "$(starship init bash)"
eval "$(fzf --bash)"
eval "$(zoxide init bash)"

# Make fzf use fd for faster, cleaner searches
export FZF_DEFAULT_COMMAND='fd --type f --type d --strip-cwd-prefix --hidden --follow --exclude .git'
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"

source "$HOME/.fzf/shell/completion.bash"

# Tell fzf to use the 'cd' fuzzy completion logic for 'z'
complete -F _fzf_dir_completion -o default -o bashdefault z

{{- $features := dig .chezmoi.hostname (dict) .hosts_features -}}

{{- if (dig "setup_gui" false $features) }}
# PyCharm is only installed on GUI machines
# export PATH="$HOME/.local/share/applications/pycharm-community-2024.2/bin:$PATH"
{{- end }}

{{- if (dig "setup_nvidia" false $features) }}
# Nvidia specific aliases
alias nvidia-limit="sudo nvidia-smi -pm 1 && sudo nvidia-smi -pl 100"
{{- end }}

{{- if eq .chezmoi.hostname "fractal" }}
alias trackmania="cd /mnt/ext4_data/projects/trackmania_rl/ && conda activate tm311"
{{- end }}


HISTSIZE=100000
HISTFILESIZE=100000
shopt -s histappend
PROMPT_COMMAND="history -a; history -c; history -r; $PROMPT_COMMAND"

#---  NVM Configuration: lazy-loaded
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
#_load_nvm() {
    ## Remove these stubs so they don't loop
    #unset -f nvm node npm npx
    ## Load NVM for real
    #[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    #[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
#}
#
## Create "stubs" that load NVM only when called
#nvm()  { _load_nvm; nvm "$@"; }
#node() { _load_nvm; node "$@"; }
#npm()  { _load_nvm; npm "$@"; }
#npx()  { _load_nvm; npx "$@"; }

{{- if eq .chezmoi.hostname "ALFR-CY5VCK3-L" }}
export NODE_EXTRA_CA_CERTS="/usr/local/share/ca-certificates/ZscalerRootCA.crt"
{{- end }}

#--- Add a "tempwork" command that creates a temporary directory that will be automatically deleted after exit.
tempwork() {
  local tdir
  tdir=$(mktemp -d)
  # Open a new sub-shell inside the temp directory
  (
    cd "$tdir" || return
    echo "Entering temporary workspace: $tdir"
    echo "This directory will be deleted when you type 'exit'."
    $SHELL
    rm -rf "$tdir"
    echo "Workspace $tdir deleted."
  )
}


#--- Tmux utility
# Create, attach, or switch to a tmux session by name from both inside or outside tmux.
# Usage: tm <session-name>

tm() {
  # 1. Check if a session name was provided
  if [ -z "$1" ]; then
    echo "Usage: tm <session-name>"
    return 1
  fi

  # 2. Check if the session already exists
  tmux has-session -t "$1" 2>/dev/null
  local session_exists=$?

  # 3. Create the session if it doesn't exist
  if [ $session_exists -ne 0 ]; then
    tmux new-session -d -s "$1"
    echo "Created new session: $1"
  fi

  # 4. Logic for switching/attaching
  if [ -n "$TMUX" ]; then
    # We are INSIDE tmux
    local current_session=$(tmux display-message -p '#S')

    if [ "$current_session" = "$1" ]; then
      echo "You are already in session: $1"
    else
      tmux switch-client -t "$1"
    fi
  else
    # We are OUTSIDE tmux
    tmux attach-session -t "$1"
  fi
}

# Add tab autocomplete for the "tm" command
_tm_completion() {
    local cur=${COMP_WORDS[COMP_CWORD]}
    # Get list of sessions, removing the trailing colon from tmux output
    local sessions=$(tmux list-sessions -F "#S" 2>/dev/null)
    COMPREPLY=( $(compgen -W "$sessions" -- "$cur") )
}

complete -F _tm_completion tm
