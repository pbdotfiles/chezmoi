#!/bin/bash

{{ include ".chezmoitemplates/pause_on_error" }}

set -euo pipefail

{{ include ".chezmoitemplates/sudo_keepalive" }}
sudo_keepalive

echo "======================================================="
echo "  Setting up Neovim (Stable) + LazyVim + NVM  "
echo "======================================================="

# -----------------------------------------------------------------------------
# 1. INSTALL DEPENDENCIES
# -----------------------------------------------------------------------------

# Ensure 'fd' is linked correctly (Ubuntu installs it as fdfind)
mkdir -p "$HOME/.local/bin"
if command -v fdfind >/dev/null 2>&1 && ! command -v fd >/dev/null 2>&1; then
    echo "ðŸ”— Symlinking fdfind to fd..."
    ln -sf "$(command -v fdfind)" "$HOME/.local/bin/fd"
fi

echo "FZF installation..."
# Remove apt-installed fzf if present (it's usually too old)
if dpkg -l | grep -q "^ii.*fzf"; then
    echo "âš ï¸  Found apt-installed fzf. Removing it to ensure latest version..."
    sudo apt remove -y fzf
fi
# Install/Update FZF from Git
if [ -d "$HOME/.fzf" ]; then
    echo "ðŸ”„ Updating existing FZF..."
    cd "$HOME/.fzf" && git pull && ./install --all --no-bash --no-zsh --no-fish
else
    echo "âœ¨ Installing FZF (Fresh)..."
    git clone --depth 1 https://github.com/junegunn/fzf.git "$HOME/.fzf"
    "$HOME/.fzf/install" --all --no-bash --no-zsh --no-fish
fi

# Ensure the binary is symlinked to your user bin
mkdir -p "$HOME/.local/bin"
ln -sf "$HOME/.fzf/bin/fzf" "$HOME/.local/bin/fzf"

echo "âœ… FZF Setup Complete."

#-------------------------------------------------------------------------------- 
# 1.5 MAKE PYTHON VENV WITH PYNVIM
#-------------------------------------------------------------------------------- 
# We use a dedicated venv to avoid conflicts with system python or other projects
NVIM_VENV="$HOME/.local/share/nvim/venv"

if [ ! -d "$NVIM_VENV" ]; then
    echo "ðŸ Creating Python virtual environment for Neovim..."
    python3 -m venv "$NVIM_VENV"
    
    echo "ðŸ“¦ Installing pynvim in dedicated venv..."
    "$NVIM_VENV/bin/pip" install --upgrade pip pynvim
else
    echo "âœ… Neovim Python venv already exists."
    "$NVIM_VENV/bin/pip" install --upgrade pynvim
fi

# -----------------------------------------------------------------------------
# 2. INSTALL NVM & NODE.JS (LTS)
# -----------------------------------------------------------------------------
export NVM_DIR="$HOME/.nvm"

echo "ðŸ” Fetching latest NVM version..."
NVM_VERSION=$(curl -s https://api.github.com/repos/nvm-sh/nvm/releases/latest | jq -r '.tag_name')

if [ -z "$NVM_VERSION" ] || [ "$NVM_VERSION" == "null" ]; then
    echo "âŒ Error: Could not fetch NVM version. Defaulting to v0.40.3"
    NVM_VERSION="v0.40.3"
fi

if [ ! -d "$NVM_DIR" ]; then
    echo "Installing NVM ($NVM_VERSION)..."
    git clone https://github.com/nvm-sh/nvm.git "$NVM_DIR"
    cd "$NVM_DIR"
    git checkout "$NVM_VERSION"
    cd - > /dev/null
else
    echo "âœ… NVM already installed. Checking for updates."
    cd "$NVM_DIR"
    git fetch --tags
    git checkout "$NVM_VERSION"
    cd - > /dev/null
fi

set +u # disable strict variable checking for NVM

# Load NVM for this session
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

echo "ðŸŸ¢ Installing Node.js LTS..."
nvm install --lts
nvm use --lts
nvm alias default 'lts/*'

# Install core global tools for Neovim
echo "ðŸ“¦ Installing global npm packages for Neovim..."
npm install -g neovim tree-sitter-cli

set -u # re-enable strict variable checking

# -----------------------------------------------------------------------------
# 2.5 INSTALL LAZYGIT
# -----------------------------------------------------------------------------

# Define install location matching your other binaries
BIN_DIR="$HOME/bin"
mkdir -p "$BIN_DIR"

# Check if lazygit is installed
if command -v lazygit &> /dev/null; then
    echo "Lazygit is already installed."
    # Optional: You could add version checking logic here to force updates
    # For now, we'll assume if it exists, it's fine.
else
    echo "â¬‡ï¸  Installing Lazygit (Latest)..."
    
    # Get the latest release version tag from GitHub API
    LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
    
    echo "Detected version: ${LAZYGIT_VERSION}"

    # Download the tarball
    curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz"

    # Extract just the binary
    tar xf lazygit.tar.gz lazygit

    # Install to bin
    install lazygit "$BIN_DIR"

    # Cleanup
    rm lazygit.tar.gz lazygit
    
    echo "âœ… Lazygit installed to $BIN_DIR/lazygit"
fi
# -----------------------------------------------------------------------------
# 3. INSTALL NEOVIM (LATEST STABLE BINARY)
# -----------------------------------------------------------------------------
# Uses the binary tarball to avoid AppImage FUSE issues and startup lag.

NVIM_INSTALL_PATH="$HOME/.local/share/nvim-linux-x86_64"
BIN_DIR="$HOME/bin"
mkdir -p "$BIN_DIR"

echo "ðŸ“¥ Fetching Neovim Stable..."
# Removing old install to ensure clean update
rm -rf "$NVIM_INSTALL_PATH"
rm -rf "$HOME/.local/share/nvim-linux64"

# Download Stable Tarball
curl -LO https://github.com/neovim/neovim/releases/download/stable/nvim-linux-x86_64.tar.gz

# Extract
tar -xzf nvim-linux-x86_64.tar.gz -C "$HOME/.local/share/"
rm nvim-linux-x86_64.tar.gz

# Link binary
ln -sf "$NVIM_INSTALL_PATH/bin/nvim" "$BIN_DIR/nvim"

echo "âœ… Neovim Stable installed to $BIN_DIR/nvim"
"$BIN_DIR/nvim" --version | head -n 1

# -----------------------------------------------------------------------------
# 4. CONFIGURATION MERGE (LAZYVIM + CHEZMOI)
# -----------------------------------------------------------------------------
# Strategy: Download LazyVim starter to temp, then copy ONLY MISSING files
# to ~/.config/nvim. This respects your Chezmoi dotfiles while ensuring
# the full LazyVim environment exists.

CONFIG_DIR="$HOME/.config/nvim"

echo "ðŸŽ¨ Bootstrapping LazyVim Config..."

# 1. Create a clean temp version of LazyVim starter
TEMP_DIR=$(mktemp -d)
git clone --depth 1 https://github.com/LazyVim/starter "$TEMP_DIR"
rm -rf "$TEMP_DIR/.git"

# 2. Ensure Config Dir exists
mkdir -p "$CONFIG_DIR"

# 3. Merge: Copy files from Starter -> Config, but DO NOT overwrite existing ones.
#    This preserves your Chezmoi files (lua/config/keymaps.lua, etc)
#    while filling in the rest of the LazyVim structure.
echo "ðŸ”„ Merging LazyVim starter with your dotfiles..."
cp -r --update=none "$TEMP_DIR/." "$CONFIG_DIR/" || true

# Cleanup
rm -rf "$TEMP_DIR"

echo "âœ… Configuration merged."
echo "   - Your dotfiles: PRESERVED"
echo "   - Missing LazyVim files: ADDED"

# -----------------------------------------------------------------------------
# 5. FINALIZATION
# -----------------------------------------------------------------------------
# Ensure PATH is correct for current session
export PATH="$BIN_DIR:$PATH"

echo "ðŸŽ‰ Setup Complete! Restart your shell."
echo "   Run 'nvim' to finish plugin installation."
