#!/bin/bash

{{ include ".chezmoitemplates/pause_on_error" }}

set -euo pipefail

{{ include ".chezmoitemplates/filesystem_utils" }}

{{ $drives := dig .chezmoi.hostname "drives" (list) .local_storage }}

{{ if $drives }}
    echo "Configuring systemd storage units for {{ .chezmoi.hostname }}..."

    {{ range $drives }}
    
    MOUNT_PATH="{{ .path }}"
    UUID="{{ .uuid }}"
    OWNER="{{ .owner }}"
    
    # Generate the Unit Name (e.g., mnt-wdd.mount)
    UNIT_NAME=$(systemd-escape --path --suffix=mount "$MOUNT_PATH")
    UNIT_FILE="/etc/systemd/system/$UNIT_NAME"

    echo "------------------------------------------------"
    echo "Processing $MOUNT_PATH ($UNIT_NAME)..."

    # A. Clean up old fstab (Pass both UUID and Path for safety)
    clean_legacy_fstab "$UUID" "$MOUNT_PATH"

    # B. Prepare the directory (Safely unmounts if needed)
    prepare_mount_point "$MOUNT_PATH" "$OWNER"

    # C. Write the Systemd Unit File
    echo "Writing systemd unit: $UNIT_FILE"
    cat <<EOF | sudo install -m 644 /dev/stdin "$UNIT_FILE"
[Unit]
Description=Mount Local Drive at $MOUNT_PATH
Documentation=man:systemd.unit(5)
JobRunningTimeoutSec=30

[Mount]
What=/dev/disk/by-uuid/$UUID
Where=$MOUNT_PATH
Type=ext4
Options=defaults
DirectoryMode=0755

[Install]
WantedBy=multi-user.target
EOF

    # D. Enable and Start
    echo "Reloading and starting unit..."
    sudo systemctl daemon-reload
    sudo systemctl enable --now "$UNIT_NAME"

    # E. Symlink Logic
    {{ if (index . "symlink_dirs") }}
        echo "Verifying symlinks..."
        {{ range $dir := .symlink_dirs }}
            LINK_PATH="$HOME/{{ $dir }}"
            TARGET_PATH="$MOUNT_PATH/{{ $dir }}"

            if [ -d "$LINK_PATH" ] && [ ! -L "$LINK_PATH" ]; then
                echo "  [SAFETY] Found real content at $LINK_PATH. Backing up..."
                mv "$LINK_PATH" "$HOME/backupchezmoi_{{ $dir }}_$(date +%s)"
            elif [ -L "$LINK_PATH" ]; then
                rm "$LINK_PATH"
            fi

            if [ ! -d "$TARGET_PATH" ]; then
                echo "Creating directory on drive: $TARGET_PATH"
                sudo mkdir -p "$TARGET_PATH"
                sudo chown "$OWNER:$OWNER" "$TARGET_PATH"
            fi

            ln -s "$TARGET_PATH" "$LINK_PATH"
            echo "  Linked $LINK_PATH -> $TARGET_PATH"
        {{ end }}
    {{ end }}

    {{ end }} # End range

    echo "âœ… Storage setup complete."
{{ else }}
    echo "No local storage configuration found for {{ .chezmoi.hostname }}."
{{ end }}
