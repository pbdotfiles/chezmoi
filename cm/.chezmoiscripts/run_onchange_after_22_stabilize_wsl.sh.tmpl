#!/bin/bash

{{ include ".chezmoitemplates/pause_on_error" }}

set -euo pipefail

{{ include ".chezmoitemplates/sudo_keepalive" }}
sudo_keepalive

# Only run this on WSL machines
if [ -f /proc/sys/fs/binfmt_misc/WSLInterop ] || grep -qi microsoft /proc/version; then
    echo "üõ°Ô∏è  Applying WSL Stability fixes for {{ .chezmoi.hostname }}..."

    # 1. Mask sleep/power targets (Usually in setup_server, but vital for WSL)
    sudo systemctl mask sleep.target suspend.target hibernate.target hybrid-sleep.target

    # 2. Configure logind to ignore idle/lid/power events
    LOGIND_CONF="/etc/systemd/logind.conf"
    sudo mkdir -p /etc/systemd/logind.conf.d/
    
    cat <<EOF | sudo tee /etc/systemd/logind.conf.d/wsl-stability.conf
[Login]
HandleLidSwitch=ignore
HandleLidSwitchExternalPower=ignore
HandleLidSwitchDocked=ignore
HandlePowerKey=ignore
HandleSuspendKey=ignore
HandleHibernateKey=ignore
IdleAction=ignore
EOF



    # 3. Restart logind to apply changes
    sudo systemctl restart systemd-logind
    echo "‚úÖ WSL stability configuration applied."

    # 1. Configure /etc/wsl.conf
    # This ensures systemd is on and the Windows PATH doesn't pollute your environment.
    # echo "üìù Writing /etc/wsl.conf..."

    cat <<EOF | sudo tee /etc/wsl.conf
[boot]
systemd=true

[user]
default={{ .chezmoi.username }}

[interop]
appendWindowsPath = false

[network]
generateResolvConf = true
EOF

else
    echo "Skipping WSL stability fixes (not a WSL environment)."
fi
