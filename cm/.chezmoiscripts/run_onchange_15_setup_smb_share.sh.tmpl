#!/bin/bash

set -euo pipefail

{{ include ".chezmoitemplates/filesystem_utils" }}
# MOUNT POINTS

MOUNT_POINT="/mnt/minis_share"

if mountpoint -q "$MOUNT_POINT"; then
    sudo umount "$MOUNT_POINT"
fi

prepare_mount_point "$MOUNT_POINT" "paul"

# Write .smbcredentials
cat <<EOF | sudo install -m 600 /dev/stdin /root/.smbcredentials
username=paul
password={{ (bitwardenFields "item" "Home_network").Samba_share_password.value }}
EOF

# FSTAB
SHARE_ID="//minis/share"
ENTRY="$SHARE_ID $MOUNT_POINT cifs credentials=/root/.smbcredentials,uid=1000,gid=1000,dir_mode=0755,file_mode=0755,iocharset=utf8,noauto,x-systemd.automount,_netdev 0 0"
update_fstab "$SHARE_ID" "$MOUNT_POINT" "$ENTRY"

# Re-mount everything
sudo mount -a

