#!/bin/bash

{{ include ".chezmoitemplates/pause_on_error" }}

set -euo pipefail

{{ include ".chezmoitemplates/filesystem_utils" }}

# --- Configuration ---
SHARE_REMOTE="//minis/share"
MOUNT_POINT="/mnt/minis_share"
CREDENTIALS_FILE="/root/.smbcredentials"
# Use systemd-escape to generate the unit name (e.g., mnt-minis_share.mount)
MOUNT_UNIT=$(systemd-escape --path --suffix=mount "$MOUNT_POINT")
AUTOMOUNT_UNIT=$(systemd-escape --path --suffix=automount "$MOUNT_POINT")

echo "Configuring SMB Share: $SHARE_REMOTE -> $MOUNT_POINT"

# 1. Clean Legacy Configs
clean_legacy_fstab "$SHARE_REMOTE" "$MOUNT_POINT"

# 2. Prepare credentials file
echo "Writing credentials to $CREDENTIALS_FILE..."
cat <<EOF | sudo install -m 600 /dev/stdin "$CREDENTIALS_FILE"
username={{ .chezmoi.username }}
password={{ (bitwardenFields "item" "Home_network").Samba_share_password.value }}
EOF

# 2.5 Stop existing systemd units to prevent "Target Busy" errors
echo "Stopping existing systemd units to release locks..."
sudo systemctl stop "$AUTOMOUNT_UNIT" "$MOUNT_UNIT" 2>/dev/null || true

# 3. Prepare Mount Point
prepare_mount_point "$MOUNT_POINT" "{{ .chezmoi.username }}"

# 4. Create the .mount Unit
echo "Creating Systemd Mount Unit: $MOUNT_UNIT"
cat <<EOF | sudo install -m 644 /dev/stdin "/etc/systemd/system/$MOUNT_UNIT"
[Unit]
Description=Mount Samba Share at $MOUNT_POINT
Documentation=man:systemd.mount(5)
After=network-online.target
Wants=network-online.target

[Mount]
What=$SHARE_REMOTE
Where=$MOUNT_POINT
Type=cifs
#Options=credentials=$CREDENTIALS_FILE,uid=$(id -u),gid=$(id -g),dir_mode=0755,file_mode=0755,iocharset=utf8
Options=credentials=$CREDENTIALS_FILE,uid=$(id -u),gid=$(id -g),dir_mode=0755,file_mode=0755,iocharset=utf8,soft,echo_interval=2,x-systemd.mount-timeout=5s,vers=3.1.1
TimeoutSec=5

[Install]
WantedBy=multi-user.target
EOF

# 5. Create the .automount Unit
echo "Creating Systemd Automount Unit: $AUTOMOUNT_UNIT"
cat <<EOF | sudo install -m 644 /dev/stdin "/etc/systemd/system/$AUTOMOUNT_UNIT"
[Unit]
Description=Automount Samba Share at $MOUNT_POINT
Documentation=man:systemd.automount(5)

[Automount]
Where=$MOUNT_POINT
TimeoutIdleSec=300

[Install]
WantedBy=multi-user.target
EOF

# 6. Enable and Start
# We enable the *automount* unit, not the mount unit.
echo "Reloading systemd and enabling automount..."
sudo systemctl daemon-reload
sudo systemctl enable --now "$AUTOMOUNT_UNIT"
sudo systemctl disable --now "$MOUNT_UNIT"

# Restarting it ensures that if you just changed the password/IP, it reconnects
if systemctl is-active --quiet "$MOUNT_UNIT"; then
    sudo systemctl restart "$MOUNT_UNIT"
fi

echo "âœ… SMB Share configured via Systemd Automount."
