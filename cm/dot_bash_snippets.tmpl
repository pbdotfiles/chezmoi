#--- Add a "tempwork" command that creates a temporary directory that will be automatically deleted after exit.
tempwork() {
  local tdir
  tdir=$(mktemp -d)
  # Open a new sub-shell inside the temp directory
  (
    cd "$tdir" || return
    echo "Entering temporary workspace: $tdir"
    echo "This directory will be deleted when you type 'exit'."
    $SHELL
    rm -rf "$tdir"
    echo "Workspace $tdir deleted."
  )
}


#--- Tmux utility
# Create, attach, or switch to a tmux session by name from both inside or outside tmux.
# Usage: tm <session-name>

tm() {
  # 1. Check if a session name was provided
  if [ -z "$1" ]; then
    echo "Usage: tm <session-name>"
    return 1
  fi

  # 2. Check if the session already exists
  tmux has-session -t "$1" 2>/dev/null
  local session_exists=$?

  # 3. Create the session if it doesn't exist
  if [ $session_exists -ne 0 ]; then
    tmux new-session -d -s "$1"
    echo "Created new session: $1"
  fi

  # 4. Logic for switching/attaching
  if [ -n "$TMUX" ]; then
    # We are INSIDE tmux
    local current_session=$(tmux display-message -p '#S')

    if [ "$current_session" = "$1" ]; then
      echo "You are already in session: $1"
    else
      tmux switch-client -t "$1"
    fi
  else
    # We are OUTSIDE tmux
    tmux attach-session -t "$1"
  fi
}

# Add tab autocomplete for the "tm" command
_tm_completion() {
    local cur=${COMP_WORDS[COMP_CWORD]}
    # Get list of sessions, removing the trailing colon from tmux output
    local sessions=$(tmux list-sessions -F "#S" 2>/dev/null)
    COMPREPLY=( $(compgen -W "$sessions" -- "$cur") )
}
complete -F _tm_completion tm

#--- Yazi utility
# Press 'q' to exit and stay in the same directory.
# Press 'Shift-q' to exit and remain in the original directory.
function yazi() {
	local tmp="$(mktemp -t "yazi-cwd.XXXXXX")"
	command yazi "$@" --cwd-file="$tmp"
	if cwd="$(command cat -- "$tmp")" && [ -n "$cwd" ] && [ "$cwd" != "$PWD" ]; then
		builtin cd -- "$cwd"
	fi
	rm -f -- "$tmp"
}
