# Utilities for safely managing /etc/fstab entries.


# update_fstab(identifier, full_entry)
#   Safely adds or updates a line in /etc/fstab.
#   - Robust: Removes any existing lines matching 'identifier' and appends the new 'full_entry'.
#             This ensures parameters are updated even if the UUID/ID stays the same.
#   - System-aware: Reloads systemd daemon automatically to apply changes.
#
# Usage: 
#   update_fstab "IDENTIFIER_STRING" "FULL_MOUNT_LINE"
update_fstab() {
    # use "fdisk -l" and "blkid" to get the UUID of a disk
    local id="$1"
    local entry="$2"
    local fstab="/etc/fstab"

    # 1. Remove old entries containing the identifier
    # We use sed to delete lines matching the ID. 
    if grep -q "$id" "$fstab"; then
        echo "Removing old/existing entry for '$id'..."
        sudo sed -i "/$id/d" "$fstab"
    fi

    # 2. Append the new entry
    echo "Adding/Updating entry for '$id'..."
    echo "$entry" | sudo tee -a "$fstab" > /dev/null
    
    # 3. Reload systemd to pick up changes immediately
    sudo systemctl daemon-reload
    echo "Systemd daemon reloaded."
}



# prepare_mount_point(directory, owner)
#   Creates a directory, ensures it is owned by the user, and sets the 
#   immutable attribute (+i) to prevent accidental writes when unmounted.
#   - directory: The full path to the mount point (e.g., /mnt/data)
#   - owner: The user to own the directory.
prepare_mount_point() {
    local dir="$1"
    local owner="$2"

    if [ ! -d "$dir" ]; then
        echo "Creating mount point: $dir"
        sudo mkdir -p "$dir"
    fi

    # 1. Unlock (in case it was already locked)
    sudo chattr -i "$dir"

    # 2. Set ownership
    # We use -R just in case some accidental files were created there,
    # though usually, it should be empty.
    sudo chown -R "$owner" "$dir"

    # 3. Lock (Immutable)
    # This prevents anything from writing to this folder if the drive is NOT mounted.
    sudo chattr +i "$dir"
    echo "Mount point $dir prepared and locked."
}
