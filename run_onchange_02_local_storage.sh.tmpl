#!/bin/bash

set -euo pipefail

{{ include ".chezmoitemplates/filesystem_utils" }}

{{ $drives := index .storage .chezmoi.hostname "drives" | default list }}

{{ if $drives }}
    echo "Configuring storage for {{ .chezmoi.hostname }}..."

    # Unmount all filesystems to ensure clean state before changes
    # || true is necessary due to set -euo pipefail at the beginning of the script.
    sudo umount -a || true

    {{ range $drives }}
    {{ $mountPath := .path }} 
    echo "------------------------------------------------"
    echo "Setting up {{ $mountPath }}..."

    # 1. Prepare the mount point
    prepare_mount_point "{{ $mountPath }}" "{{ .owner }}"

    # 2. Update /etc/fstab
    ENTRY="UUID=\"{{ .uuid }}\" {{ $mountPath }} ext4 defaults 0 2"
    update_fstab "{{ .uuid }}" "$ENTRY"

    # 3. Create Symlinks (if defined)
    {{ if .symlink_dirs }}
        echo "Creating symlinks..."
        {{ range $dir := .symlink_dirs }}
            # Remove existing symlink or folder safely
            if [ -L ~/"{{ $dir }}" ]; then rm ~/"{{ $dir }}"; fi
            if [ -d ~/"{{ $dir }}" ]; then rm -rf ~/"{{ $dir }}"; fi
            
            # Create new link using the captured $mountPath
            ln -s {{ $mountPath }}/"{{ $dir }}" ~/"{{ $dir }}"
            echo "  Linked ~/"{{ $dir }}" -> {{ $mountPath }}/"{{ $dir }}""
        {{ end }}
    {{ end }}

    {{ end }} # End range

    # Remount everything to apply changes immediately
    sudo mount -a
    echo "Local storage setup complete."
{{ else }}
    echo "No local storage configuration found for {{ .chezmoi.hostname }}. Skipping."
{{ end }}
